name: Scraper Diario to send email to SNP

# Ejecucion de Descargas Diarias (Last 3 days)
on:
  schedule:
    - cron: "0 14 * * *"    # 9AM
    - cron: "0 20 * * *"    # 3PM

  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 10    
    env:
      TZ: America/Lima
      DOWNLOAD_DIR: ${{ github.workspace }}/downloads

      # Credenciales de Graph
      #GRAPH_CLIENT_ID: ${{ secrets.GRAPH_CLIENT_ID }}
      #GRAPH_CLIENT_SECRET: ${{ secrets.GRAPH_CLIENT_SECRET }}
      #GRAPH_TENANT_ID: ${{ secrets.GRAPH_TENANT_ID }}

      # Credenciales del portal (SITRAPESCA)
      EMP1_RUC:   ${{ secrets.EMP1_RUC }}
      EMP1_DOC:   ${{ secrets.EMP1_DOC }}
      EMP1_PASS:  ${{ secrets.EMP1_PASS }}
      EMP3_RUC:   ${{ secrets.EMP3_RUC }}
      EMP3_DOC:   ${{ secrets.EMP3_DOC }}
      EMP3_PASS:  ${{ secrets.EMP3_PASS }}


    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1


      - name: Show Chrome version
        run: chrome --version

      - name: Run scraper (headless)
        run: |
          mkdir -p "$DOWNLOAD_DIR"
          python scrapping_diario.py
          echo "Archivos descargados:"
          ls -lah "$DOWNLOAD_DIR" || true

      - name: Send CSVs to SNP via Microsoft Graph (direct)
        shell: bash
        env:
            GRAPH_TENANT_ID: ${{ secrets.GRAPH_TENANT_ID }}
            GRAPH_CLIENT_ID: ${{ secrets.GRAPH_CLIENT_ID }}
            GRAPH_CLIENT_SECRET: ${{ secrets.GRAPH_CLIENT_SECRET }}
            DOWNLOAD_DIR: ${{ env.DOWNLOAD_DIR }}
        run: |
            python - << 'PY'
            import os, glob, json, base64, sys
            import requests

            #PERIODO = "II 2025"
            
            tenant = os.environ["GRAPH_TENANT_ID"]
            client_id = os.environ["GRAPH_CLIENT_ID"]
            client_secret = os.environ["GRAPH_CLIENT_SECRET"]
            download_dir = os.environ["DOWNLOAD_DIR"]
  
            # Token 
            token_url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"
            token_resp = requests.post(token_url, data={
                "client_id": client_id,
                "client_secret": client_secret,
                "scope": "https://graph.microsoft.com/.default",
                "grant_type": "client_credentials",
            }, timeout=30)
            token_resp.raise_for_status()
            access_token = token_resp.json()["access_token"]
  
            # Leer CSVs
            files = sorted(glob.glob(os.path.join(download_dir, "*.csv")))
            if not files:
                print(f"No hay CSVs en {download_dir}")
                sys.exit(1)
  
            attachments = []
            for path in files:
                with open(path, "rb") as f:
                    content_b64 = base64.b64encode(f.read()).decode("utf-8")
                attachments.append({
                    "@odata.type": "#microsoft.graph.fileAttachment",
                    "name": os.path.basename(path),
                    "contentType": "text/csv",
                    "contentBytes": content_b64
                })
  
            to_list  = ["glecca@snp.org.pe","speraltilla@snp.org.pe","emeneses@snp.org.pe"] 
            cc_list  = ["jrobles@exalmar.com.pe","jvega@exalmar.com.pe"]
            bcc_list = ["dabad@exalmar.com.pe","ccarhuayo@exalmar.com.pe","cmarin@exalmar.com.pe"]
  
            payload = {
                "message": {
                    "subject": "REPORTE DE CALAS SITRAPESCA CN II 2025",
                    "body": {"contentType": "Text", "content": "Se adjuntan los reportes de SITRAPESCA. \n\nSaludos,"},
                    "toRecipients":  [{"emailAddress": {"address": x}} for x in to_list],
                    "ccRecipients":  [{"emailAddress": {"address": x}} for x in cc_list],
                    "bccRecipients": [{"emailAddress": {"address": x}} for x in bcc_list],
                    "attachments": attachments
                },
                "saveToSentItems": "true"
            }
  
            url = f"https://graph.microsoft.com/v1.0/users/exalmarpa@exalmar.com.pe/sendMail"
            resp = requests.post(url, headers={
                "Authorization": f"Bearer {access_token}",
                "Content-Type": "application/json"
            }, json=payload, timeout=60)
  
            if resp.status_code not in (202, 200):
                print("Graph sendMail error:", resp.status_code, resp.text)
                sys.exit(1)
  
            print(f"OK: enviado correo con {len(attachments)} adjuntos desde exalmarpa@exalmar.com.pe")
            PY
          
